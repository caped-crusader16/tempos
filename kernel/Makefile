##
# Copyright (C) 2009 RenÃª de Souza Pinto
# TempOS - Tempos is an Educational and multi purpose Operating System
#
# Makefile - TempOS Build System
#

PWD := $(shell pwd)


# Default files and dirs
kimage     := tempos.elf
bimage     := boot.iso

conffile   := .config
config_def := scripts/config.default
config_mk  := scripts/Makefile.config
config_h   := include/config.h

doxycfg    := doc/doxygen.cfg
doxydir    := doc/doxygen

objlist    := objs.list

checkarch  := scripts/checkarch.sh

ECHO       := $(shell which echo)


# Default values
CC = gcc
LD = ld
CFLAGS = -Wall

# Compilation tools
DEPTOOL  := scripts/deptool.sh


# Export all variables
export

# Pseudo rules
.PHONY: showtitle help clean


all: showtitle $(kimage)

showtitle:
	@$(ECHO) " ===================== "
	@$(ECHO) "[ TempOS Build System ]"
	@$(ECHO) " ===================== "

$(kimage): tempos

tempos: $(config_mk)
	@[ -f $(objlist) ] && rm -f $(objlist) || echo " * Sanity check"
	@$(ECHO) -n " * Checking architecture..."
	@$(checkarch) $(conffile)

##
# Read configuration file and generate proper files
#
$(config_mk): $(conffile)
	@$(ECHO) " ====================== "
	@$(ECHO) "[ TempOS Configuration ]"
	@$(ECHO) " ====================== "
	@$(ECHO) " + READING $(conffile)"
	 
	@$(ECHO) " + WRITING $(config_mk)"
	@$(ECHO) -e "##\n# This file was automatic generated by TempOS Build System\n# WARNING: Do not edit.\n#\n" > $(config_mk)
	@sed -n "s/ \{0,\}\(\w\+\) \{0,\}= \{0,\}\(.*\)/\1=\2\\nexport \1/gp" $(conffile) >> $(config_mk)

	@$(ECHO) " + WRITING $(config_h)"
	@$(ECHO) -e "/*\n * This file was automatic generated by TempOS Build System\n * WARNING: Do not edit.\n **/\n" > $(config_h)
	@$(ECHO) -e "#ifndef TEMPOS_CONFIG_H\n\n\t#define TEMPOS_CONFIG_H\n" >> $(config_h)
	@sed -n "s/ \{0,\}\(\w\+\) \{0,\}= \{0,\}\(.*\)/\t#define \1 \2/gp" $(conffile) >> $(config_h)
	@$(ECHO) -e "\n#endif /* TEMPOS_CONFIG_H */\n" >> $(config_h)

-include $(config_mk)

##
# Use a default configuration file
#
$(conffile):
	@$(ECHO) "****************************************************************************"
	@$(ECHO) "* WARNING: Kernel build configuration file not found. Use default options. *"
	@$(ECHO) "****************************************************************************"
	@cp $(config_def) $(conffile)

##
# doc
#
doc: showtitle
	@$(ECHO) "Generating source code documentation..."
	@[ -z "$(shell which doxygen)" ] && ( $(ECHO) "Doxygen not found. Please, install doxygen (http://doxygen.org)" ) || doxygen $(doxycfg)

##
# help
#
help:
	@$(ECHO) " ========================== "
	@$(ECHO) "[ TempOS Build System Help ]"
	@$(ECHO) " ========================== "
	@$(ECHO)
	@$(ECHO) "Kernel targets:"
	@$(ECHO) "  all             - Build TempOS kernel"
	@$(ECHO)
	@$(ECHO) "Cleaning targets:"
	@$(ECHO) "  clean           - Remove generated files but keep configuration file."
	@$(ECHO)
	@$(ECHO) "Testing targets:"
	@$(ECHO) "  install         - Generates a bootable floppy disk image with TempOS kernel"
	@$(ECHO) "  test            - Run TempOS on an emulator"
	@$(ECHO)
	@$(ECHO) "Documentation targets:"
	@$(ECHO) "  doc             - Generates TempOS source code documentation."
	@$(ECHO)

##
# test
#
test: showtitle $(kimage)
	@$(ECHO) -n " * Checking architecture..."
	@[ -f "$(bimage)" ] && ($(checkarch) $(conffile) test) \
		|| ($(ECHO) -e "!\n * Running make..."; $(MAKE) --quiet install && $(MAKE) --quiet test)


##
# install
#
install: showtitle $(kimage)
	@$(ECHO) -n " * Checking architecture..."
	@$(checkarch) $(conffile) install


##
# clean
#
clean: showtitle
	@$(ECHO) "Cleaning..."
	@$(ECHO) -n " * Checking architecture..."
	@$(checkarch) $(conffile) clean
	@[ -d $(doxydir) ] && (rm -rf $(doxydir) && $(ECHO) " - REMOVING $(doxydir)") || $(ECHO) " ! $(doxydir) not found."
# These rules should stay after architecture clean
	@[ -f $(config_mk) ] && (rm -f $(config_mk) && $(ECHO) " - REMOVING $(config_mk)") || $(ECHO) " ! $(config_mk) not found."
	@[ -f $(config_h) ] && (rm -f $(config_h) && $(ECHO) " - REMOVING $(config_h)") || $(ECHO) " ! $(config_h) not found."
	@$(ECHO) done.

